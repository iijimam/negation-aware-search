# æ„å‘³ã¯ä¼¼ã¦ã„ã‚‹ã®ã«æ­£åå¯¾ï¼Ÿ â€• ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®é™ç•Œã‚’LLMã§è£œã£ãŸå®Ÿè·µãƒ•ãƒ­ãƒ¼

ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚„ç”»åƒã€éŸ³å£°ãªã©ã‚’AIãƒ¢ãƒ‡ãƒ«ã§æ•°å€¤ãƒ™ã‚¯ãƒˆãƒ«ã«å¤‰æ›ã—ã€æ„å‘³çš„ã«è¿‘ã„ã‚‚ã®ã‚’æ¢ã™ã“ã¨ãŒã§ãã‚‹æ¤œç´¢æ‰‹æ³•ã§ã™ã€‚ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã§ã¯é›£ã—ã‹ã£ãŸã€ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã®ã€Œæ„å‘³çš„ãªé¡ä¼¼æ¤œç´¢ã€ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

ã§ã™ãŒã€å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹ã¨ã€Œæ„å‘³ã¯è¿‘ã„ã‘ã‚Œã©ã€å†…å®¹ã¨ã—ã¦ã¯æ­£åå¯¾ã€ã®å†…å®¹ãŒæ¤œç´¢ä¸Šä½ã«å«ã¾ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã—ãŸã€‚

ç‰¹ã«ã€è‚¯å®šãƒ»å¦å®šã‚’åŒºåˆ¥ã™ã‚‹ã“ã¨ãŒé‡è¦ãªå ´é¢ã§ã¯ã€èª¤ã£ãŸå›ç­”ã‚’è¿”ã™ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€ã“ã®å•é¡Œã¯ç„¡è¦–ã§ããªã„ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚

![](./assets/image.jpg)

ãã“ã§ã€ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§ã¯æ‰±ã„ãã‚Œãªã„ã€Œè«–ç†ã®é•ã„ã€ã‚’LLMã¨SQLã‚’çµ„ã¿åˆã‚ã›ã¦è£œå®Œã—ãŸæ§‹æˆã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

>æœ¬è¨˜äº‹ã¯ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè£…è§£èª¬ã§ã¯ãªãã€è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®å…±æœ‰ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

ä»¥ä¸‹ã®æµã‚Œã§ã”ç´¹ä»‹ã—ã¾ã™ã€‚

[(1) ãªãœãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã ã‘ã§ã¯è¶³ã‚Šãªã„ã®ã‹](#1-ãªãœãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã ã‘ã§ã¯è¶³ã‚Šãªã„ã®ã‹)

[(2) å¦å®šå•é¡Œã¯Embeddingã®é™ç•Œ](#2-å¦å®šå•é¡Œã¯embeddingã®é™ç•Œ)

[(3) LLMã¯æ¤œç´¢ã®å‰å‡¦ç†ãƒ»å¾Œå‡¦ç†ã«ä½¿ã£ã¦ã¿ã‚ˆã†](#3-llmã¯æ¤œç´¢ã®å‰å‡¦ç†å¾Œå‡¦ç†ã«ä½¿ã£ã¦ã¿ã‚ˆã†)

[(4) æ„å‘³æ¤œç´¢ Ã— è«–ç†æ¤œç´¢ã®åˆ†é›¢è¨­è¨ˆ](#4-æ„å‘³æ¤œç´¢--è«–ç†æ¤œç´¢ã®åˆ†é›¢è¨­è¨ˆ)

[(5) ãƒªãƒ©ãƒ³ã‚¯ï¼ˆCross Encoderï¼‰ã¨LLM as a Judgeã§æ­£ã—ã•ã‚’è¨¼æ˜](#5-ãƒªãƒ©ãƒ³ã‚¯cross-encoderã¨llm-as-a-judgeã§æ­£ã—ã•ã‚’è¨¼æ˜)

[(6) IRIS Ã— Embedded Python ã§æ¤œç´¢ã‚’DBã«é–‰ã˜è¾¼ã‚ã‚‹](#6-iris--embedded-python-ã§æ¤œç´¢ã‚’dbã«é–‰ã˜è¾¼ã‚ã‚‹)

[(7) ã“ã®è¨­è¨ˆãŒå‘ããƒ‰ãƒ¡ã‚¤ãƒ³ï¼å‘ã‹ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³](#7-ã“ã®è¨­è¨ˆãŒå‘ããƒ‰ãƒ¡ã‚¤ãƒ³å‘ã‹ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³)

[(8) ã¾ã¨ã‚](#8ã¾ã¨ã‚)

[(9) ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œæ–¹æ³•](#9ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œæ–¹æ³•)


## (1) ãªãœãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã ã‘ã§ã¯è¶³ã‚Šãªã„ã®ã‹

ã¾ãšã¯ã€é­é‡ã—ãŸã€Œæ„å‘³ã¯è¿‘ã„ã‘ã‚Œã©ã€å†…å®¹ã¨ã—ã¦ã¯æ­£åå¯¾ã€ã®ä¾‹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã«åˆ©ç”¨ã—ãŸå†…å®¹ã§ã™ãŒã€æ‚£è€…ãŒç—…é™¢ã‚’é€€é™¢ã™ã‚‹éš›ã€åŒ»å¸«ãŒä½œæˆã™ã‚‹é€€é™¢æ™‚ã‚µãƒãƒªã‚’é¡Œæã¨ã—ã€ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã®è³ªå•æ–‡ã‹ã‚‰ç—…åãƒ»çŠ¶æ…‹ãŒè¿‘ã„ç—‡ä¾‹ã‚’æ¢ã™ç›®çš„ã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’è¡Œã£ã¦ã„ã¾ã™ï¼ˆLLMã§ç”Ÿæˆã—ãŸæ¶ç©ºæƒ…å ±200ä»¶ã§ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ï¼‰ã€‚

---

è³ªå•æ–‡ï¼šé«˜ç†±ã¨å’³ã§å…¥é™¢ã— **SpO2ä½ä¸‹ã®ãŸã‚çŸ­æœŸé–“é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸã€‚** è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã§ã€æŠ—èŒè–¬ã§ã¯ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã§æ”¹å–„ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã€TOP 5 ã®çµæœã§ã™ã€‚

`20 - `ã§å§‹ã¾ã‚‹è¡Œã«è³ªå•æ–‡ã¨åå¯¾ã®æ„å‘³ã¨ãªã‚‹ **ã€ŒSpO2 96%ï¼ˆå®¤å†…æ°—ï¼‰ã§é…¸ç´ æŠ•ä¸ã¯è¡Œã‚ãªã‹ã£ãŸã€‚ã€** ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
```
194 - ã€å…¥é™¢çµŒéã€‘ç™ºç†±ã¨å’³å—½ã§å…¥é™¢ã€‚è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã€‚å‘¼å¸è‹¦ãŒã‚ã‚ŠSpO2ä½ä¸‹ã«å¯¾ã—é…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½ã€‚è‚ºç‚æ‰€è¦‹ã¯æ˜ç¢ºã§ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã«æ”¹å–„ã—è‡ªå®…é€€é™¢ã€‚
184 - ã€å…¥é™¢çµŒéã€‘ç™ºç†±ãƒ»å’³å—½ãƒ»é–¢ç¯€ç—›ã§å…¥é™¢ã€‚è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã€‚å‘¼å¸è‹¦ã«å¯¾ã—SpO2ä½ä¸‹ãŒã‚ã‚Šé…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½ã€‚è‚ºç‚æ‰€è¦‹ã¯æ˜ç¢ºã§ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã«æ”¹å–„ã—è‡ªå®…é€€é™¢ã€‚
20 - ã€å…¥é™¢çµŒéã€‘ç™ºç†±ã¨å’³å—½ã§å…¥é™¢ã€‚SpO2 96%ï¼ˆå®¤å†…æ°—ï¼‰ã§é…¸ç´ æŠ•ä¸ã¯è¡Œã‚ãªã‹ã£ãŸã€‚é™å±€æ€§è‚ºç‚ã¨ã—ã¦æŠ—èŒè–¬ç‚¹æ»´ã§æ²»ç™‚ã—æ”¹å–„ã€é€€é™¢ã€‚ICUå…¥å®¤ã¯è¡Œã£ã¦ã„ãªã„ã€‚
41 - ã€å…¥é™¢çµŒéã€‘ç™ºç†±ã¨æ¯åˆ‡ã‚Œã§å…¥é™¢ã€‚SpO2 90ã€œ92%ã§é…¸ç´ æŠ•ä¸é–‹å§‹ã€‚è‚ºç‚ã¨ã—ã¦æŠ—èŒè–¬ç‚¹æ»´ã§æ²»ç™‚ã—æ”¹å–„ã€é…¸ç´ é›¢è„±å¾Œã«é€€é™¢ã€‚ICUå…¥å®¤ã¯è¡Œã£ã¦ã„ãªã„ã€‚
17 - ã€å…¥é™¢çµŒéã€‘ç™ºç†±ã¨å‘¼å¸å›°é›£ã§å…¥é™¢ã€‚SpO2 90ã€œ91%ã§é…¸ç´ æŠ•ä¸é–‹å§‹ã€‚è‚ºç‚ã¨ã—ã¦æŠ—èŒè–¬ç‚¹æ»´æ²»ç™‚ã‚’è¡Œã„æ”¹å–„ã€é…¸ç´ é›¢è„±å¾Œã«é€€é™¢ã€‚ICUå…¥å®¤ã¯è¡Œã£ã¦ã„ãªã„ã€‚
```

ã€Œé…¸ç´ æŠ•ä¸ã‚’è¡Œã‚ãªã‹ã£ãŸã€ã‚ã¨ã«ã€Œé…¸ç´ æŠ•ä¸é–‹å§‹ã€ã®çµæœãŒç¶šã„ã¦ã„ã‚‹ãŸã‚ã€ã“ã‚Œã¯çµæœã¨ã—ã¦ä¸æ­£ç¢ºãªçŠ¶æ…‹ã¨è¨€ãˆã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿æ•°ã®å•é¡Œã¨ã„ã†ã‚ˆã‚Šã‚‚ã€ã€Œã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶ã€ã€Œç™ºç†±ã€ã€Œå…¥é™¢çµŒéã€ã¨ã„ã£ãŸæ–‡è„ˆãŒå…±é€šã—ã¦ã„ã‚‹ãŸã‚ã€é…¸ç´ æŠ•ä¸ã®æœ‰ç„¡ã¨ã„ã†è«–ç†çš„ãªå·®ç•°ãŒé¡ä¼¼åº¦ã«åæ˜ ã•ã‚Œã«ãã„ä¾‹ã¨è¨€ãˆã¾ã™ã€‚

ã§ã¯ã€ãªãœã€ã€Œå†…å®¹ã¨ã—ã¦æ­£åå¯¾ã€ãŒãƒ’ãƒƒãƒˆã—ã¦ã—ã¾ã†ã®ã§ã—ã‚‡ã†ã‹ã€‚


## (2) å¦å®šå•é¡Œã¯Embeddingã®é™ç•Œ

ãƒ†ã‚¹ãƒˆã§ã¯ã€ä¸€èˆ¬çš„ãªãƒ¢ãƒ‡ãƒ«ï¼ˆOpenAIã®Embeddingãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’åˆ©ç”¨ã—ã¦ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã¦ã„ã¾ã™ã€‚

ã€Œå†…å®¹ã¨ã—ã¦æ­£åå¯¾ã€ãŒãƒ’ãƒƒãƒˆã—ã¦ã—ã¾ã†ã“ã¨ã‚’å•é¡Œã¨ã—ã¦æŒ‡æ‘˜ã™ã‚‹è«–æ–‡ãŒã‚ã‚Šã¾ã™ã€‚

> æ•°å¤šãã®å…ˆè¡Œç ”ç©¶ã«ã‚ˆã‚Šã€BERTã€ELMOã€RoBERTaã€XLNetãªã©ã®æ–‡è„ˆä¾å­˜ãƒ†ã‚­ã‚¹ãƒˆåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã¯å¦å®šè¡¨ç¾ã‚’æ­£ç¢ºã«ç†è§£ã™ã‚‹ä¸Šã§èª²é¡Œã‚’æŠ±ãˆã¦ã„ã‚‹ã“ã¨ãŒæ˜ã‚‰ã‹ã«ãªã£ã¦ã„ã‚‹ã€‚ï¼ˆNumerous prior studies have found that contextual text embedding models such as BERT, ELMO, RoBERTa or XLNet face challenges in accurately understanding negation.ï¼‰ 

LLMã«è¦ç´„ã—ã¦ã‚‚ã‚‰ã£ãŸå†…å®¹ã«ã‚ˆã‚‹ã¨ã€**è‚¯å®šæ–‡ã¨å¦å®šæ–‡ãŒé«˜ã„é¡ä¼¼åº¦ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã¦ã—ã¾ã†ç¾è±¡ãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹ã€‚** ãã†ã§ã™ã€‚ã€€

>Universal Text Embedding ã‚’å¯¾è±¡ã¨ã—ãŸè¿‘å¹´ã®ç ”ç©¶ã§ã¯ã€å¦å®šè¡¨ç¾ã‚’å«ã‚€æ–‡ãƒšã‚¢ã«ãŠã„ã¦ã€**è‚¯å®šæ–‡ã¨å¦å®šæ–‡ãŒé«˜ã„é¡ä¼¼åº¦ã¨ã—ã¦è©•ä¾¡ã•ã‚Œã¦ã—ã¾ã†ç¾è±¡ãŒå ±å‘Šã•ã‚Œã¦ã„ã‚‹ã€‚** è‘—è€…ã‚‰ã¯ã“ã®å•é¡Œã‚’ **Negation Blindness** ã¨å‘¼ã³ã€å¦å®šã«å¯¾ã™ã‚‹æ„Ÿåº¦ãŒåŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ‡ãƒ«ã®æ±ç”¨æ€§ã‚’æãªã£ã¦ã„ã‚‹ã“ã¨ã‚’å®Ÿé¨“çš„ã«ç¤ºã—ã¦ã„ã‚‹ã€‚

å‚è€ƒæ–‡çŒ®ï¼š[Semantic Adapter for Universal Text Embeddings: Diagnosing and Mitigating Negation Blindness to Enhance Universality, arXiv:2504.00584](https://arxiv.org/abs/2504.00584)

Embeddingãƒ¢ãƒ‡ãƒ«ã¯ç‰¹å®šãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç‰¹åŒ–ã—ãŸã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ç‰¹å®šãƒ‰ãƒ¡ã‚¤ãƒ³å‘ã‘Embeddingã®æ¯”è¼ƒã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ãŒã€å°‘ãªãã¨ã‚‚Embeddingæ¤œç´¢å˜ä½“ã§ã¯ã€å¦å®šãƒ»è‚¯å®šã‚’æ¤œç´¢æ¡ä»¶ã¨ã—ã¦å³å¯†ã«åˆ¶å¾¡ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

## (3) LLMã¯æ¤œç´¢ã®å‰å‡¦ç†ãƒ»å¾Œå‡¦ç†ã«ä½¿ã£ã¦ã¿ã‚ˆã†

ã‚ã‚‹ç”¨èªã«å¯¾ã—ã¦å¦å®šãƒ»è‚¯å®šã‚’äºˆã‚ç¢ºèªã§ãã‚Œã°ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢æ™‚ã«ãã®ç”¨èªã«å¯¾ã™ã‚‹å¦å®šãƒ»è‚¯å®šã‚’æŒ‡å®šã—ãŸæ¤œç´¢ãŒè¡Œãˆã€æ­£åå¯¾ã®æ„å‘³ã‚’æ’é™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ãã“ã§ã€æœ¬è¨˜äº‹ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ã€è³ªå•æ–‡ã‚„æ¤œç´¢å¯¾è±¡ã¨ãªã‚‹ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¯¾è±¡ã¨ãªã‚‹é‡è¦ç”¨èªã‚’æŠ½å‡ºã—ã€ãã®ç”¨èªãŒæ–‡ä¸­ã§å¦å®šãƒ»è‚¯å®šã®ã©ã¡ã‚‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã€ã©ã¡ã‚‰ã¨ã‚‚åˆ¤æ–­ä»˜ã‹ãªã„çŠ¶æ…‹ã§ã‚ã‚‹ã‹ã‚’LLMã«ç¢ºèªã•ã›ã¦ã„ã¾ã™(å¦å®š(0)ã€è‚¯å®š(1)ã€ä¸æ˜(null) ã®ã„ãšã‚Œã‹ã®å€¤ã‚’è¿”ã™ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã¾ã™)ã€‚

ã¾ãŸã€æŠ½å‡ºã—ãŸç”¨èªã®ä¸­ã§**å¼·ãçµã‚Šè¾¼ã¿ã‚’ã—ãŸã„ã‚‚ã®**ã¯ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ ã¨ã—ã¦ç™»éŒ²ã—ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢æ™‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚

ãã®ä»–ã®ç”¨èªã¯ã€LLMã‹ã‚‰æŠ½å‡ºã—ãŸçµæœã®JSONãã®ã¾ã¾ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ ¼ç´ã—ã€é¡ä¼¼ã™ã‚‹ãƒˆãƒƒãƒ—3ä»¶ã‚’çµã£ãŸå¾Œã€æœ¬å½“ã«ä¼¼ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’LLMã‚’åˆ©ç”¨ã—ã¦å¯©æŸ»ï¼ˆLLM as a judgeï¼‰ã™ã‚‹éš›ã®ãƒ‡ãƒ¼ã‚¿ã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ï¼ˆé‡è¦ç”¨èªã®çŠ¶æ…‹ãŒè³ªå•æ–‡ã¨é¡ä¼¼å€™è£œæ–‡ã§ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã«åˆ©ç”¨ï¼‰ã€‚

ãªãŠã€é‡è¦ç”¨èªã‚’LLMã«è‡ªå‹•çš„ã«æŠ½å‡ºã•ã›ã‚‹ã®ã§ã¯ãªãã€æŠ½å‡ºã—ãŸã„ç”¨èªã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚

ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¸€éƒ¨ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```
SYSTEM_PROMPT = """ã‚ãªãŸã¯åŒ»ç™‚æ–‡æ›¸ã‹ã‚‰ã€Œå…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã«æ˜ç¤ºã•ã‚ŒãŸè¨˜è¼‰ã€ã ã‘ã«åŸºã¥ã„ã¦ã€æŒ‡å®šãƒ•ãƒ©ã‚°ã‚’æ§‹é€ åŒ–æŠ½å‡ºã™ã‚‹æƒ…å ±æŠ½å‡ºå™¨ã§ã™ã€‚
å‡ºåŠ›ã¯ **JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿** ã¨ã—ã€æœªç¢ºå®šã¯ **null** ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚
# æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ï¼ˆæ¨è«–ã‚¼ãƒ­ï¼‰
- æ¨è«–ãƒ»è£œå®Œãƒ»å¸¸è­˜åˆ¤æ–­ã¯ç¦æ­¢ã€‚å…¥åŠ›ã«ã€Œæ˜ç¤ºã€ã•ã‚Œã¦ã„ãªã„äº‹é …ã¯ value=nullã€‚
- ä»–ã®ãƒ•ãƒ©ã‚°ã‚„è‡¨åºŠå¸¸è­˜ã‹ã‚‰ã®æ¨å®šã¯ç¦æ­¢ã€‚
- value ã‚’ 1 ã¾ãŸã¯ 0 ã«ã™ã‚‹å ´åˆã€å¿…ãš evidence ã«æ ¹æ‹ ã®åŸæ–‡æŠœç²‹ï¼ˆ1ã€œ2æ–‡ä»¥å†…ï¼‰ã‚’ãã®ã¾ã¾å…¥ã‚Œã‚‹ã€‚
- evidence ã¯å…¥åŠ›ã‹ã‚‰ã®å¼•ç”¨ã§ã€æ”¹å¤‰ã—ãªã„ï¼ˆå¥èª­ç‚¹ã®çœç•¥ã¯å¯ï¼‰ã€‚ä½œã‚Šè©±ã¯ç¦æ­¢ã€‚
- ã€Œè¨˜è¼‰ãªã—ï¼ˆnullï¼‰ã€ã¨ã€Œå¦å®šï¼ˆ0ï¼‰ã€ã¯åˆ¥ç‰©ã€‚å¦å®šè¡¨ç¾ãŒæ˜ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ 0 ã‚’ä»˜ã‘ã‚‹ã€‚
- confidence ã¯ 0ã€œ1ã€‚æ ¹æ‹ ãŒç›´æ¥ãƒ»æ˜ç¢ºãªã‚‰é«˜ãã€æ›–æ˜§ãªã‚‰ä½ãã™ã‚‹ã€‚
- scope ã‚’å¿…ãšå‡ºåŠ›ã™ã‚‹:
  - inpatient / history / discharge_plan / unknown
# å¦å®šã®æ‰±ã„ï¼ˆå¿…ãšè€ƒæ…®ï¼‰
- å¦å®šä¾‹ï¼šãªã— / ãªã„ / ãªã / è¡Œã‚ãš / ä¸è¦ / ä¸­æ­¢ / è¦‹é€ã‚Š / ã›ãš / ã—ãªã„ / å®Ÿæ–½ã›ãš / å°å…¥ã›ãš / æŠ•ä¸ã›ãš / ä½¿ç”¨ã›ãš
# åˆ¤å®šåŸºæº–ï¼ˆè¾æ›¸ï¼‰
- HasOxygenTherapy:
  - 1: é…¸ç´ æŠ•ä¸ / é¼»ã‚«ãƒ‹ãƒ¥ãƒ© / ãƒã‚¹ã‚¯ / ãƒªã‚¶ãƒ¼ãƒ / é…¸ç´ â—¯L / é…¸ç´ æŠ•ä¸é–‹å§‹ / O2æŠ•ä¸
  - 0: é…¸ç´ ãªã— / é…¸ç´ æŠ•ä¸ã›ãš / é…¸ç´ ä¸è¦ / å®¤å†…æ°—ã§çµŒé
- HasHFNC:
  - 1: HFNC / ãƒã‚¤ãƒ•ãƒ­ãƒ¼ / High flow / ãƒãƒ¼ã‚¶ãƒ«ãƒã‚¤ãƒ•ãƒ­ãƒ¼
  - 0: HFNCãªã— / HFNCå°å…¥ã›ãš / HFNCä¸è¦
- HasNPPV:
  - 1: NPPV / CPAP / BiPAP / éä¾µè¥²çš„é™½åœ§æ›æ°—
  - 0: NPPVãªã— / NPPVå°å…¥ã›ãš / NPPVä¸è¦
- HasIntubation:
  - 1: æŒ¿ç®¡ / æ°—ç®¡æŒ¿ç®¡ / æŒ¿ç®¡ç®¡ç†
  - 0: æŒ¿ç®¡ã›ãš / éæŒ¿ç®¡
ï¼œçœç•¥ï¼
```
>ç”¨èªãƒ¡ãƒ¢ï¼š
> - HNFCï¼šé…¸ç´ ã‚’å¢—ã‚„ã™ãŸã‚ã®é«˜æµé‡é¼»ã‚«ãƒ‹ãƒ¥ãƒ©ã«ã‚ˆã‚‹é…¸ç´ ç™‚æ³•
> - NPPVï¼šå‘¼å¸ã‚’åŠ©ã‘ã‚‹ãŸã‚ã®ãƒã‚¹ã‚¯ã‚’ä½¿ã£ãŸéä¾µè¥²çš„äººå·¥å‘¼å¸ç™‚æ³•


ã“ã®ãƒ•ãƒ­ãƒ¼ã®ä¸­ã§ã®LLMã®åˆ©ç”¨ã¯ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å‰å‡¦ç†ã¨å¾Œå‡¦ç†ã«ç™»å ´ã—ã¾ã™ã€‚

- å‰å‡¦ç†

    ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè³ªå•æ–‡ï¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚ã‚‹æ–‡ï¼‰ã‹ã‚‰é‡è¦ç”¨èªã¨ã—ã¦è¨­å®šã—ãŸç”¨èªã¨ãã®çŠ¶æ…‹ã‚’LLMã«æŠ½å‡ºã•ã›ã¾ã™ï¼ˆçµæœã¯ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå›ºå®šã®JSONã§å—ã‘å–ã‚Šã¾ã™ï¼‰ã€‚

    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²ã™ã‚‹æ–‡ç« ã«ã¤ã„ã¦ã¯ã€é‡è¦ç”¨èªã®ä¸­ã§å¼·ãçµã‚Šè¾¼ã¿ã‚’ç”¨èªã‚’å®šã‚ã€ã‚«ãƒ©ãƒ ã¨ã—ã¦å®šç¾©ã—å€¤ï¼ˆ0/1/nullï¼‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²ã—ã¾ã™ã€‚


- å¾Œå‡¦ç†

    ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢çµæœã®ä¸Šä½3ä»¶ãŒè³ªå•æ–‡ã¨æ­£ã—ãé¡ä¼¼ã—ã¦ã„ã‚‹ã‹ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã«ã€LLMã«ã‚ˆã‚‹å¯©æŸ»ï¼ˆLLM as a Judgeï¼‰ã‚’è¡Œã„ã¾ã™ã€‚

    å¯©æŸ»æ™‚ã«ã€å‰å‡¦ç†ã§æŠ½å‡ºã—ãŸè³ªå•æ–‡ã®é‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã®JSONã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰æŠ½å‡ºã—ãŸåŒæ§˜ã®JSONã‚’æ¯”è¼ƒã•ã›ã€æ„å‘³çš„ã«çŸ›ç›¾ãŒãªã„ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

<details>

<summary>ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã‚’LLMã«æŠ½å‡ºã—ã¦ã‚‚ã‚‰ã£ãŸJSONä¾‹ï¼š</summary>

    ã€å…¥é™¢çµŒéã€‘ç™ºç†±ã¨å’³å—½ã§å…¥é™¢ã€‚è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã€‚å‘¼å¸è‹¦ãŒã‚ã‚ŠSpO2ä½ä¸‹ã«å¯¾ã—é…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½ã€‚è‚ºç‚æ‰€è¦‹ã¯æ˜ç¢ºã§ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã«æ”¹å–„ã—è‡ªå®…é€€é™¢ã€‚
    ```
    {
        "HasOxygenTherapy": {
            "value": 1,
            "polarity": "affirmed",
            "evidence": "å‘¼å¸è‹¦ãŒã‚ã‚ŠSpO2ä½ä¸‹ã«å¯¾ã—é…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½",
            "confidence": 1.0,
            "scope": "inpatient",
            "note": ""
        },
        "HasHFNC": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasNPPV": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasIntubation": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasMechanicalVentilation": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasTracheostomy": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasICUCare": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasSepsis": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasShock": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasVasopressor": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasAKI": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasDialysis": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasDiabetes": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "history",
            "note": ""
        },
        "HasInsulinUse": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "unknown",
            "note": ""
        },
        "HasAntibioticsIV": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "inpatient",
            "note": ""
        },
        "HasAntibioticsPO": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "inpatient",
            "note": ""
        },
        "HasSteroidSystemic": {
            "value": null,
            "polarity": "unknown",
            "evidence": null,
            "confidence": 0.0,
            "scope": "inpatient",
            "note": ""
        }
    }   
    ```
</details>

<br>

å‰å‡¦ç†ã«ã‚ˆã‚Šã€è³ªå•æ–‡ã®ä¸­ã«é‡è¦ç”¨èªãŒã‚ã‚Šã€çµã‚Šè¾¼ã‚€å¿…è¦ãŒã‚ã‚Œã°çµã‚Šè¾¼ã¿ãŒè¡Œãˆã¾ã™ï¼ˆæ­£åå¯¾ã®æ„å‘³ã‚’é™¤å¤–ã§ãã¾ã™ï¼‰ã€‚

å¾Œå‡¦ç†ã§ã€å€™è£œã¨ã—ã¦æ®‹ã£ãŸæ–‡ç« ãŒæ­£ã—ã„æŠ½å‡ºã§ã‚ã‚‹ã“ã¨ã‚’ã€äº‹å‰ã«åˆ‡ã‚Šå‡ºã—ãŸé‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã‚’ä½¿ã£ã¦è¨¼æ˜ã§ãã¾ã™ã€‚

---

ã“ã“ã§ã€ã“ã®è¨˜äº‹ã®ãƒ•ãƒ­ãƒ¼ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

è³ªå•æ–‡ï¼ˆãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‹ã‚‰é‡è¦ç”¨èªã«å¯¾ã™ã‚‹å¦å®šãƒ»è‚¯å®šãƒ»ä¸æ˜ï¼ˆ0/1/nullï¼‰ã‚’æŠ½å‡º

ã€€â†“

è³ªå•æ–‡ã§ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆTOP 100æŠ½å‡ºï¼‰

ã€€â†“

ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãã‚‹å ´åˆã€çµã‚Šè¾¼ã¿ï¼‹è³ªå•æ–‡ã§ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆTOP 50æŠ½å‡ºï¼‰

ã€€â†“

2ã¤ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®çµæœã‚’ãƒãƒ¼ã‚¸ã—ã€å¦å®šãªã®ã«è‚¯å®šãŒå«ã¾ã‚Œãªã„ã‹å†ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ãƒã‚§ãƒƒã‚¯ï¼‰

ã€€â†“

ä¸Šä½50ä»¶ã«å¯¾ã—ã¦ãƒªãƒ©ãƒ³ã‚¯ï¼ˆCross Encodingï¼‰å®Ÿæ–½

ã€€â†“

ä¸Šä½3ä»¶ãŒæ­£ã—ã„æŠ½å‡ºã§ã‚ã‚‹ã“ã¨ã‚’LLMã§å¯©æŸ»ï¼ˆLLM as a Judgeï¼‰

ãªãœã€é¡ä¼¼æ¤œç´¢ã‚’2å›è¡Œã£ã¦ã„ã‚‹ã®ã‹ã€æœ€åˆã®é¡ä¼¼æ¤œç´¢ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ãŸã‚‰ã„ã„ã®ã§ã¯ï¼Ÿã¨æ€ã‚ã‚Œã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

æ¬¡ã®é …ç›®ã§ãªãœã€2å›é¡ä¼¼æ¤œç´¢ã‚’è¡Œã£ãŸã‹ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## (4) æ„å‘³æ¤œç´¢ Ã— è«–ç†æ¤œç´¢ã®åˆ†é›¢è¨­è¨ˆ

ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢æ™‚ã«äºˆã‚å¦å®šãƒ»è‚¯å®šãŒåˆ¤æ˜ã—ã¦ã„ã‚‹ã‚‚ã®ã«å¯¾ã—ã¦ã€çµã‚Šè¾¼ã¿ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã®ã§ã€1å›ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã§çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ãŒã€ã“ã®ãƒ•ãƒ­ãƒ¼ã§ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚

ç†ç”±ã¯ã€çµã‚Šè¾¼ã‚€ã“ã¨ã§æƒ…å ±ã®è½ã¨ã—ã™ãã¦ã—ã¾ã„ã€å–ã‚Šã“ã¼ã—ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€å–ã‚Šã“ã¼ã—ã‚’é˜²ããŸã‚ã®æ¤œç´¢ã¨ï¼ˆTOP 100ï¼‰ã€æ¤œç´¢çµæœã‚’æ­£ã—ãçµã‚Šè¾¼ã‚€ãŸã‚ã®æ¤œç´¢ï¼ˆTOP 50ï¼‰ã‚’åˆ†ã‘ã€æœ€å¾Œã«ãƒãƒ¼ã‚¸ã—ã¦ã„ã¾ã™ã€‚

- TOP 100

    æ„å‘³ãŒè¿‘ãã†ãªã‚‚ã®ã‚’ã¨ã«ã‹ãæ¼ã‚Œãªãé›†ã‚ã‚‹ã€‚å¤šå°‘ãŠã‹ã—ãªãƒ‡ãƒ¼ã‚¿ãŒæ··ã–ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã€‚

- TOP 50 ï¼‹ çµã‚Šè¾¼ã¿

    å†…å®¹ãŒæ­£åå¯¾ã«ãªã‚‹ï¼ˆè«–ç†ãŒé€†è»¢ã—ã¦ã„ã‚‹ï¼‰ã‚‚ã®ã‚’æ˜ç¤ºçš„ã«é™¤å¤–ã€‚æ„å‘³ã¯è¿‘ã„ãŒæ¡ä»¶ãŒé•ã†ã‚‚ã®ã‚’è½ã¨ã™ã€‚
    
    å…ˆã»ã©ã®é€€é™¢æ™‚ã‚µãƒãƒªã®ä¾‹ã§ã™ã¨ã€Œé…¸ç´ æŠ•ä¸ã€ãŒ**æ˜ç¢ºã«ã‚ã‚‹ã¨ç¢ºèªã§ããŸå ´åˆ**ã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ã§çµã‚Šè¾¼ã¿ã¾ã™ï¼ˆé…¸ç´ æŠ•ä¸ï¼šHasOxygenTherapyï¼‰ã€‚

    ```
    SELECT TOP :topN
    c.DocId, c.SectionText, c.FlagsJson,
    VECTOR_COSINE(c.Embedding, TO_VECTOR(:query_vec, FLOAT, 1536)) AS score_text,
    d.PatientId,d.DischargeDate
    FROM Demo.DischargeSummaryChunk c, Demo.DischargeSummaryDoc d
    WHERE d.DocId=c.DocId AND (c.SectionType = 'hospital_course')
        AND (c.HasOxygenTherapy = 1)
    ORDER BY score_text DESC
    ```

    é…¸ç´ æŠ•ä¸ãŒ**æ˜ç¢ºã«ã‚ã‚‹ã¨ç¢ºèªã§ããªã‹ã£ãŸå ´åˆ**ã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ã¨ãªã‚Šã¾ã™ã€‚
    ```
    SELECT TOP :topN
    c.DocId, c.SectionText, c.FlagsJson,
    VECTOR_COSINE(c.Embedding, TO_VECTOR(:query_vec, FLOAT, 1536)) AS score_text,
    d.PatientId,d.DischargeDate
    FROM Demo.DischargeSummaryChunk c, Demo.DischargeSummaryDoc d
    WHERE d.DocId=c.DocId AND (c.SectionType = 'hospital_course')
        AND (c.HasOxygenTherapy IS NULL OR c.HasOxygenTherapy = 0)
    ORDER BY score_text DESC
    ```

![](./assets/flow.jpg)

>â€» å›³ä¸­ã®ã€Œé‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã€ã¯ã€è³ªå•æ–‡ãŠã‚ˆã³æ¤œç´¢å¯¾è±¡æ–‡æ›¸ã«å¯¾ã—ã¦äº‹å‰ã«LLMã§æŠ½å‡ºãƒ»ä¿å­˜ã—ãŸæƒ…å ±ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚

2ã¤ã®æ¤œç´¢çµæœã‚’ãƒãƒ¼ã‚¸ã—ãŸå¾Œã€å†åº¦LLMã‹ã‚‰æŠ½å‡ºã—ãŸé‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã‚’ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã€Œè³ªå•æ–‡ãŒå¦å®šã—ã¦ã„ã‚‹ã®ã«æ¤œç´¢çµæœã¯è‚¯å®šã—ã¦ã„ã‚‹ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã„ã‹ç¢ºèªã—ã¾ã™ã€‚

ã“ã“ã§ã¯ã€ã€Œçµ¶å¯¾ã«å…¥ã‚ŒãŸããªã„çŸ›ç›¾ã€ã ã‘ã‚’é™¤å¤–ã—ã¾ã™ã€‚è»½å¾®ãªä¸ä¸€è‡´ã‚„ä¸æ˜(null)ã¯ã€å¾Œè¿°ã™ã‚‹ãƒªãƒ©ãƒ³ã‚¯ã¨LLMã«ã‚ˆã‚‹å¯©æŸ»ã«å§”ã­ã¾ã™ã€‚

<details>
<summary>ãƒãƒ¼ã‚¸å¾Œã«è¡Œã£ã¦ã„ã‚‹å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ï¼š<a href="./src/UI_embedded_python/search.py">search.py</a></summary>

```
#-----------------------------------
# 2å›ã®é¡ä¼¼æ¤œç´¢çµæœã¨è³ªå•æ–‡ã‚’åˆ©ç”¨ã—ã¦
# ç‰¹å®šç”¨èªã«å¯¾ã™ã‚‹å¦å®šï¼ˆ0ï¼‰ãŒè³ªå•æ–‡ã«é£Ÿã„é•ã„ãŒãªã„ã‹ã®ãƒã‚§ãƒƒã‚¯
# (çµ¶å¯¾ã«å…¥ã‚ŒãŸããªã„çŸ›ç›¾ã‚’é™¤å¤–ã™ã‚‹ï¼šWHEREã§å–ã‚Šé™¤ã‘ãªã„ã‚‚ã®ã€ãƒãƒ¼ã‚¸å¾Œã®æ··å…¥ã‚’é™¤å¤–)
# è³ªå•æ–‡ãŒå¼·ãå¦å®š(0)ãªã®ã«DBå´ã§è‚¯å®š(1)ã—ã¦ã„ã‚‹å ´åˆã€çµæœã‹ã‚‰å–ã‚Šé™¤ã
# ï¼ˆLLMãŒå›ç­”ã—ãŸconfidenceã®å€¤ã‚’åˆ©ç”¨ï¼šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã©ã®å€¤ä»¥ä¸Šãªã‚‰å–ã‚Šé™¤ãã‚’æŒ‡å®šå¯ï¼‰
# DBå´ãŒ value==1 ã§ã‚‚ confidence ãŒä½ã„å ´åˆã¯èª¤çˆ†ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚é™¤å¤–ã—ãªã„
#-----------------------------------
def hard_exclude_contradictions(
    results,
    query_text,
    query_flags,
    hard_flags=None,
    conf_th=0.9,         # queryå´
    doc_conf_th=0.8,     # docå´
    bypass_accept_if_query_conf_ge=0.99,
):
    q = normalize_flags_dict(query_flags)
    hard_flags = hard_flags or ["HasOxygenTherapy"]

    out = results
    for flag_name in hard_flags:
        fq = q.get(flag_name, {})
        if not (isinstance(fq, dict) and fq.get("value", None) == 0):
            continue

        q_conf = float(fq.get("confidence", 0.0) or 0.0)
        if q_conf < conf_th:
            continue

        # è¶…é«˜ä¿¡é ¼ãªã‚‰ _should_accept_negation ã‚’å¿…é ˆã«ã—ãªã„
        if q_conf < bypass_accept_if_query_conf_ge:
            if not _should_accept_negation(flag_name, fq, query_text):
                continue

        kept = []
        for r in out:
            d = normalize_flags_dict(r.get("FlagsJson"))
            dv = _get_value(d, flag_name)

            d_obj = d.get(flag_name, {})
            d_conf = 0.0
            if isinstance(d_obj, dict):
                try:
                    d_conf = float(d_obj.get("confidence", 0.0) or 0.0)
                except (TypeError, ValueError):
                    d_conf = 0.0

            # ç¢ºã‹ã‚‰ã—ã„ã€Œ1ã€ã ã‘è½ã¨ã™
            if dv == 1 and d_conf >= doc_conf_th:
                continue

            kept.append(r)

        out = kept

    return out
```
</details>



## (5) ãƒªãƒ©ãƒ³ã‚¯ï¼ˆCross Encoderï¼‰ã¨LLM as a Judgeã§æ­£ã—ã•ã‚’è¨¼æ˜

ãƒãƒ¼ã‚¸ã—ãŸçµæœã‹ã‚‰TOP 50ã®ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã¯æ§˜ã€…ãªã‚‚ã®ãŒåˆ©ç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ãŒã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€ã€ŒBAAI/bge-reranker-v2-m3ã€ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

Cross Encoder ã¯å¦å®šãƒ»è‚¯å®šã¨ã„ã£ãŸè«–ç†æ§‹é€ ã‚’ç†è§£ã™ã‚‹ã‚‚ã®ã§ã¯ãªãã€**è³ªå•æ–‡ã¨å€™è£œæ–‡ã®ãƒšã‚¢ã«å¯¾ã—ã¦ã€Œæ„å‘³çš„ãªè¿‘ã•ã€ã‚’ç²¾å¯†ã«ã‚¹ã‚³ã‚¢åŒ–ã—ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†æ§‹æˆã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚**

ã¾ãŸã€ãƒªãƒ©ãƒ³ã‚¯å¾Œã®TOP 3ã®æƒ…å ±ã¨æŠ½å‡ºã—ãŸé‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã®JSONã‚’åˆ©ç”¨ã—ã¦ã€æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ãŒä¼¼ã¦ã„ã‚‹ã‹ã‚’LLMã«å¯©æŸ»ã•ã›ã¦ã„ã¾ã™ï¼ˆLLM as a judgeï¼‰ã€‚

ãƒªãƒ©ãƒ³ã‚¯å¾Œã®å˜ç´”ãªã‚¹ã‚³ã‚¢æ¯”è¼ƒã§ã¯ãªãã€é‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã®JSONã‚’åˆ©ç”¨ã—ã€è³ªå•æ–‡ã¨å€™è£œæ–‡ã¨ã§é£Ÿã„é•ã„ãŒãªã„ã‹ã‚’ç¢ºèªã—ã¦ã„ã‚‹ãŸã‚ã€ãªãœãã®åˆ¤æ–­ã¨ãªã£ãŸã‹ã®èª¬æ˜ãŒã§ãã‚‹æ–¹æ³•ã¨è¨€ãˆã¾ã™ã€‚

æœ€å¾Œã®LLM as a Judgeã«æ¸¡ã—ã¦ã„ã‚‹JSONã«ã¯ã€è³ªå•æ–‡ã¨ãƒªãƒ©ãƒ³ã‚¯å¾Œã®TOP3ã®é‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã‚¹ã‚³ã‚¢ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
<details>
<summary>å®Ÿéš›ã«æ¸¡ã—ã¦ã„ã‚‹JSONã®ä¸­èº«ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãªã©ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã”å‚ç…§ä¸‹ã•ã„ï¼š<a href="./src/UI_embedded_python/app.py">app.py</a>ï¼‰</summary>

```
{'query_flags': {'HasOxygenTherapy': {'value': 1, 'polarity': 'affirmed', 'evidence': 'SpO2ä½ä¸‹ã®ãŸã‚çŸ­æœŸé–“é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸ', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
        }, 'HasHFNC': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasNPPV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasIntubation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasMechanicalVentilation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasTracheostomy': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasICUCare': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasSepsis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasShock': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasVasopressor': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasAKI': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasDialysis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasDiabetes': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasInsulinUse': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasAntibioticsIV': {'value': 0, 'polarity': 'negated', 'evidence': 'æŠ—èŒè–¬ã§ã¯ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã§æ”¹å–„ã—ã¾ã—ãŸ', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
        }, 'HasAntibioticsPO': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }, 'HasSteroidSystemic': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
        }
    }, 'ranked_top3': [
        {'DocId': 194, 'FlagsJson': {'HasOxygenTherapy': {'value': 1, 'polarity': 'affirmed', 'evidence': 'å‘¼å¸è‹¦ãŒã‚ã‚ŠSpO2ä½ä¸‹ã«å¯¾ã—é…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
                }, 'HasHFNC': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasNPPV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasIntubation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasMechanicalVentilation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasTracheostomy': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasICUCare': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasSepsis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasShock': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasVasopressor': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasAKI': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasDialysis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasDiabetes': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'history', 'note': ''
                }, 'HasInsulinUse': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasAntibioticsIV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAntibioticsPO': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasSteroidSystemic': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }
            }
        },
        {'DocId': 184, 'FlagsJson': {'HasOxygenTherapy': {'value': 1, 'polarity': 'affirmed', 'evidence': 'å‘¼å¸è‹¦ã«å¯¾ã—SpO2ä½ä¸‹ãŒã‚ã‚Šé…¸ç´ æŠ•ä¸ã‚’çŸ­æœŸé–“å®Ÿæ–½', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
                }, 'HasHFNC': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasNPPV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasIntubation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasMechanicalVentilation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasTracheostomy': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasICUCare': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasSepsis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasShock': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasVasopressor': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAKI': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasDialysis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasDiabetes': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'history', 'note': ''
                }, 'HasInsulinUse': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAntibioticsIV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAntibioticsPO': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasSteroidSystemic': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }
            }
        },
        {'DocId': 161, 'FlagsJson': {'HasOxygenTherapy': {'value': 1, 'polarity': 'affirmed', 'evidence': 'çµŒéä¸­ã«ä¸€éæ€§ã®ä½ä¸‹ã‚’èªã‚çŸ­æ™‚é–“ã®ã¿é…¸ç´ ã‚’ä½¿ç”¨ã—ãŸ', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
                }, 'HasHFNC': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasNPPV': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasIntubation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasMechanicalVentilation': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasTracheostomy': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasICUCare': {'value': 0, 'polarity': 'negated', 'evidence': 'ICUå…¥å®¤ã¯è¡Œã‚ãš', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
                }, 'HasSepsis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasShock': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasVasopressor': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAKI': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasDialysis': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasDiabetes': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasInsulinUse': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'unknown', 'note': ''
                }, 'HasAntibioticsIV': {'value': 1, 'polarity': 'affirmed', 'evidence': 'æŠ—èŒè–¬æ²»ç™‚ã‚’é–‹å§‹ã—ãŸ', 'confidence': 1.0, 'scope': 'inpatient', 'note': ''
                }, 'HasAntibioticsPO': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }, 'HasSteroidSystemic': {'value': None, 'polarity': 'unknown', 'evidence': None, 'confidence': 0.0, 'scope': 'inpatient', 'note': ''
                }
            }
        }
    ]
}
```
</details>

<br>

ç¢ºã‹ãªæƒ…å ±ãŒé‡è¦è¦–ã•ã‚Œã‚‹åŒ»ç™‚ãƒ»æ³•å‹™ãƒ»æ¥­å‹™æ¤œç´¢ã®ä¸­ã«å–ã‚Šå…¥ã‚Œã‚‹å ´åˆã«ã¯ã€åˆ¤æ–­ã®æ ¹æ‹ ãŒå¿…è¦ä¸å¯æ¬ ã§ã‚ã‚‹ãŸã‚ã€ã“ã®æµã‚Œã‚‚1ã¤ã®æ–¹æ³•ã«ãªã‚Šå¾—ã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

### è£œè¶³ï¼šJudge ã®å†ç¾æ€§ã«ã¤ã„ã¦

ã“ã®è¨˜äº‹ã§è¡Œã£ãŸæ¤œè¨¼ã§ã¯ã€æ—¥æœ¬èªç’°å¢ƒã«ãŠã„ã¦ LLM ã‚’ç”¨ã„ãŸ Judge ãŒå®‰å®šã—ã¦å‹•ä½œã‚’ã—ã¦ã„ã¾ã™ãŒã€æ¤œè¨¼ã‚’é€²ã‚ã‚‹ä¸­ã§ã€Judge ã®æŒ™å‹•ã«ã¯è¨€èªä¾å­˜æ€§ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ç‰¹ã«è‹±èªç’°å¢ƒã§ã¯ã€åŒä¸€ã®åˆ¤å®šãƒ«ãƒ¼ãƒ«ã‚’ä¸ãˆã¦ã‚‚LLM ãŒåŒ»ç™‚çš„æ–‡è„ˆã‚’è£œå®Œã—ã¦è§£é‡ˆã—ã¦ã—ã¾ã„ã€å³å¯†ãª if/else åˆ¤å®šã¨ã—ã¦ã®å†ç¾æ€§ãŒä½ä¸‹ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ãã®ãŸã‚ã€å®Ÿé‹ç”¨ã«ãŠã„ã¦ã¯ã€Judge éƒ¨åˆ†ã¯ Python ç­‰ã«ã‚ˆã‚‹æ±ºå®šè«–çš„ãªå®Ÿè£…ã¨ã—ã€LLM ã¯ãƒ•ãƒ©ã‚°æŠ½å‡ºã‚„èª¬æ˜ç”Ÿæˆã«é™å®šã™ã‚‹æ§‹æˆãŒå®‰å®šã—ãŸåˆ©ç”¨ã«ãªã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

## (6) IRIS Ã— Embedded Python ã§æ¤œç´¢ã‚’DBã«é–‰ã˜è¾¼ã‚ã‚‹

ä»Šå›ã®ãƒ•ãƒ­ãƒ¼ã§ã¯ã€ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚‹ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ãŒ2å›ç™»å ´ã—ã¾ã™ã€‚

ã¾ãŸã€ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã€é¡ä¼¼æ¤œç´¢ã§è¦‹ã¤ã‹ã£ãŸæƒ…å ±ãã‚Œãã‚Œã®ã€é‡è¦ç”¨èªã¨ã®ãã®çŠ¶æ…‹ã‚’æŠ½å‡ºã—ãŸJSONã‚‚å–å¾—ã—ãŸã„ãŸã‚ã€å¤§é‡ã®æƒ…å ±ã‚’æ‰±ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

é€šå¸¸ã€æ¤œç´¢å‡¦ç†ã§ã¯ã€å¤§é‡æƒ…å ±ã®è»¢é€å›æ•°ã‚’ã§ãã‚‹ã ã‘æ¸›ã‚‰ã™å·¥å¤«ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

IRISã§å®Ÿç¾ã§ãã‚‹1ã¤ã®æ‰‹æ®µã¨ã—ã¦ã€Embedded Pythonã®åˆ©ç”¨ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

> ğŸ“– Embedded Pythonã«ã¤ã„ã¦è©³ã—ãã¯ã€[ã‚¦ã‚§ãƒ“ãƒŠãƒ¼ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼šPythonã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°](https://youtu.be/fMxWwf3alNY?list=PLzSN_5VbNaxB39_H2QMMEG_EsNEFc0ASz)ï¼[è¨˜äº‹ï¼šEmbedded Pythonã‚’ç°¡å˜ã«ã”ç´¹ä»‹ã—ã¾ã™](https://jp.community.intersystems.com/node/511336) ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

SQLã®å®Ÿè¡Œã¯SQLAlchemyã§ã‚‚è¡Œãˆã¾ã™ãŒã€Embedded Pythonã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã«ã¤ãªãŒã‚‹2å›ã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚’ã‚µãƒ¼ãƒãƒ¼å´ã§å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã€å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®è»¢é€ã‚’è¡Œã‚ãšã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## (7) ã“ã®è¨­è¨ˆãŒå‘ããƒ‰ãƒ¡ã‚¤ãƒ³ï¼å‘ã‹ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³

å‘ã„ã¦ã„ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦

- ITé‹ç”¨ãƒ»éšœå®³å¯¾å¿œï¼ˆé‹ç”¨ãƒ­ã‚°ï¼ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆè¨˜éŒ²ï¼‰

    ä¾‹ï¼šã€Œâ—‹â—‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸãŒã€å†èµ·å‹•ã¯ã—ã¦ã„ãªã„ã€‚æš«å®šå¯¾å¿œã®ã¿å®Ÿæ–½ã€ã®ä¸­ã§ã€Œå†èµ·å‹•ã—ãŸï¼ã—ã¦ãªã„ã€ã«ã‚ˆã‚Šå¯¾å¿œãŒå¤‰ã‚ã‚‹ã“ã¨ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚
    
    ã€Œå¯¾å¿œã—ãŸï¼ã—ã¦ã„ãªã„ã€ã€Œå›é¿ç­–ã‚ã‚Šï¼ãªã—ã€ã®å¦å®šãƒ»è‚¯å®šã®åˆ¤æ–­ãŒéšœå®³å¯¾å¿œã§ã‚‚é‡è¦ã«ãªã£ã¦ãã¾ã™ã€‚

- å¥‘ç´„ãƒ»æ³•å‹™ãƒ»ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ï¼ˆå¥‘ç´„æ¡æ–‡ãƒ»éå»åˆ¤æ–­ï¼‰

    ä¾‹ï¼šæ³•å‹™ãƒ»å¥‘ç´„æ‹…å½“ãŒã€Œé€”ä¸­è§£ç´„ã¯å¯èƒ½ã ãŒã€é•ç´„é‡‘ã¯ç™ºç”Ÿã—ãªã„ã‚±ãƒ¼ã‚¹ã€

    ã“ã®å ´åˆã‚‚ã€ã€Œï½ã—ãŸï¼ï½ã—ã¦ãªã„ã€ãŒé‡è¦ãªåˆ¤æ–­ææ–™ã¨ãªã‚Šã¾ã™ã€‚

- åŒ»ç™‚ï¼ˆé€€é™¢æ™‚ã‚µãƒãƒªã®é¡ä¼¼æ¤œç´¢ï¼‰

    ä¾‹ï¼šã€Œé«˜ç†±ã¨å’³ã§å…¥é™¢ã— **SpO2ä½ä¸‹ã®ãŸã‚çŸ­æœŸé–“é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸã€‚** è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã§ã€æŠ—èŒè–¬ã§ã¯ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã§æ”¹å–„ã—ã¾ã—ãŸã€‚ã€

    è‚¯å®šæ–‡ã«å¦å®šãŒæ··ã–ã‚‹ã€å¦å®šæ–‡ã«è‚¯å®šãŒæ··ã–ã‚‹ã“ã¨ã‚’é¿ã‘ãŸã„å ´åˆã«ã€å¦å®šãƒ»è‚¯å®šã®åˆ¤æ–­ãŒé‡è¦ã«ãªã£ã¦ãã¾ã™ã€‚

---

å‘ã„ã¦ã„ãªã„ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã—ã¦

- æ„Ÿæƒ³ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»SNSæŠ•ç¨¿ã®æ¤œç´¢

    ä¾‹ï¼šã€Œã“ã®æ˜ ç”»ã¯é¢ç™½ã‹ã£ãŸï¼ã¤ã¾ã‚‰ãªã‹ã£ãŸã€ã€Œå¯¾å¿œãŒå†·ãŸã‹ã£ãŸã€

    ã“ã‚Œã‚‰ã¯ã€å¦å®šãƒ»è‚¯å®šãŒæ•°å€¤çš„ãƒ»è«–ç†çš„ãªæ¡ä»¶ã§ã¯ãªãã€å€‹äººã®ä¸»è¦³ã‚„æ„Ÿæƒ…ã«å¼·ãä¾å­˜ã™ã‚‹ãŸã‚ã€æœ¬è¨˜äº‹ã®ã‚ˆã†ã«ã€Œé‡è¦ç”¨èªã¨ãã®çŠ¶æ…‹ã€ã‚’å®šç¾©ã—ã¦ã‚‚æ¤œç´¢ç²¾åº¦ã®å‘ä¸Šã«ã¤ãªãŒã‚Šã«ãã„ã‚±ãƒ¼ã‚¹ã§ã™ã€‚

- ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«æ¤œç´¢ï¼ˆç”»åƒãƒ»éŸ³å£°ãƒ»å‹•ç”»ä¸­å¿ƒï¼‰

    æœ¬æ§‹æˆã¯ã€ãƒ†ã‚­ã‚¹ãƒˆå†…ã®å¦å®šãƒ»è‚¯å®šã¨ã„ã£ãŸè«–ç†æ§‹é€ ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚

    ç”»åƒã‚„éŸ³å£°ãŒä¸»ã¨ãªã‚‹æ¤œç´¢ã§ã¯ã€å¦å®šãƒ»è‚¯å®šã‚’æ˜ç¤ºçš„ã«æ§‹é€ åŒ–ã™ã‚‹ã“ã¨è‡ªä½“ãŒé›£ã—ãã€æœ¬è¨˜äº‹ã®ãƒ•ãƒ­ãƒ¼ã‚’ãã®ã¾ã¾é©ç”¨ã™ã‚‹ã®ã¯é©ã—ã¦ã„ã¾ã›ã‚“ã€‚

- é›‘è«‡ãƒ»æ¢ç´¢ç›®çš„ã®æ¤œç´¢

    ã€Œãªã‚“ã¨ãªãä¼¼ãŸè©±é¡Œã‚’æ¢ã—ãŸã„ã€
    
    ã€Œé–¢é€£ã—ãã†ãªæƒ…å ±ã‚’åºƒãçœºã‚ãŸã„ã€

    ã¨ã„ã£ãŸç”¨é€”ã§ã¯ã€è«–ç†çš„ãªå³å¯†æ€§ã‚ˆã‚Šã‚‚å¤šæ§˜æ€§ãŒé‡è¦–ã•ã‚Œã‚‹ãŸã‚ã€æœ¬æ§‹æˆã¯ã‚„ã‚„éå‰°ãªè¨­è¨ˆã«ãªã‚Šã¾ã™ã€‚


## (8)ã¾ã¨ã‚

è¨˜äº‹ã§ã”ç´¹ä»‹ã—ãŸæ§‹æˆã¯ã€Embeddingãƒ¢ãƒ‡ãƒ«ã§åˆ¤æ–­ã—ã«ãã„å¦å®šãƒ»è‚¯å®šã«å¯¾ã—ã¦ã€ã€Œæ„å‘³æ¤œç´¢ã€ã¨ã€Œè«–ç†åˆ¤æ–­ã€ã‚’å½¹å‰²åˆ†æ‹…ã•ã›ã‚‹ã“ã¨ã§ã€å®Ÿå‹™ã§ç ´ç¶»ã—ã«ãã„æ¤œç´¢ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ§‹æˆã§ã™ã€‚

é‡è¦ç”¨èªã‚’æŒ‡å®šã§ãã‚Œã°ä¾‹ã«ç™»å ´ã—ãŸåŒ»ç™‚æƒ…å ±ã ã‘ã§ãªãã€å¦å®šãƒ»è‚¯å®šã®åˆ¤æ–­ã‚’é‡è¦ã¨ã™ã‚‹ä»–ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚‚åˆ©ç”¨ã§ãã¾ã™ã€‚


## (9)ã‚µãƒ³ãƒ—ãƒ«å®Ÿè¡Œæ–¹æ³•

Embedded Pythonç‰ˆã¨SQLAlchemyç‰ˆãŒã‚ã‚Šã¾ã™ã€‚

ã©ã¡ã‚‰ã‚‚OpenAIã‚’åˆ©ç”¨ã—ã¾ã™ã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠé–‹å§‹å‰ã«[.env](/.env)ã«APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
```
OPENAI_API_KEY=sk-x*****
```

ã‚³ãƒ³ãƒ†ãƒŠé–‹å§‹ï¼š
```
docker compose up -d
```

ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€ä»¥ä¸‹ã®ã©ã¡ã‚‰ã‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```
docker exec -it nagation_aware_search bash
```

- Embedded Pythonç‰ˆ

    [UI_embedded_python](/src/UI_embedded_python/) ä»¥ä¸‹ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

    å®Ÿè¡Œã«ã¯ irispython ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

    ```
    /usr/irissys/bin/irispython /home/irisowner/.local/bin/streamlit run /src/UI_embedded_python/app.py --server.port 8080 --logger.level=debug
    ```

    ç”»é¢ã®èµ·å‹•ï¼š[http://localhost:8081](http://localhost:8081)

- SQLAlchemyç‰ˆ

    [UI_sqlalchemy](/src/UI_embedded_python/) ä»¥ä¸‹ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚

    å®Ÿè¡Œæ–¹æ³•ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

    ```
    /home/irisowner/.local/bin/streamlit run /src/UI_sqlalchemy/app.py --server.port 8090 --logger.level=debug
    ```

    ç”»é¢ã®èµ·å‹•ï¼š[http://localhost:8091](http://localhost:8091)

- è³ªå•ã‚µãƒ³ãƒ—ãƒ«
    - ç™ºç†±ã¨å’³ã¯ã‚ã‚Šã¾ã—ãŸãŒã€é…¸ç´ ã¯ä½¿ã‚ãšã«çµŒéã—ã¾ã—ãŸã€‚è‚ºç‚ã§å…¥é™¢ã—ã¾ã—ãŸãŒæ¯”è¼ƒçš„è»½ç—‡ã§ã—ãŸã€‚
    - å¸‚ä¸­è‚ºç‚ã§å…¥é™¢ã—ã¾ã—ãŸãŒã€å…¥é™¢ä¸­ã¯çµ‚å§‹å®¤å†…æ°—ã§ã€é…¸ç´ æŠ•ä¸ã¯ä¸è¦ã§ã—ãŸã€‚
    - è‚ºç‚ã®ãŸã‚å…¥é™¢ã¨ãªã‚Šã¾ã—ãŸãŒã€å‘¼å¸çŠ¶æ…‹ã¯å®‰å®šã—ã¦ãŠã‚Šé…¸ç´ ç®¡ç†ã¯è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚
    - å‘¼å¸è‹¦ã®ãŸã‚å…¥é™¢ã—ã€é…¸ç´ æŠ•ä¸ã‚’è¡Œã„ã¾ã—ãŸãŒã€ICUç®¡ç†ã¾ã§ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    - å…¥é™¢æ™‚ã«ä½é…¸ç´ ãŒã‚ã‚Šé¼»ã‚«ãƒ‹ãƒ¥ãƒ©ã§å¯¾å¿œã—ã¾ã—ãŸãŒã€ä¸€èˆ¬ç—…æ£Ÿã§çµŒéã—ã¦ã„ã¾ã™ã€‚
    - é…¸ç´ æŠ•ä¸ã¯è¡Œã„ã¾ã—ãŸãŒã€é‡ç—‡åŒ–ã›ãšICUã«ã¯å…¥å®¤ã—ã¦ã„ã¾ã›ã‚“ã€‚
    - é‡ç—‡è‚ºç‚ã§å…¥é™¢ã—ã€å‘¼å¸çŠ¶æ…‹æ‚ªåŒ–ã®ãŸã‚ICUç®¡ç†ã¨ãªã‚Šã¾ã—ãŸã€‚
    - å…¥é™¢å¾Œã«å‘¼å¸ä¸å…¨ã‚’èªã‚ã€é›†ä¸­æ²»ç™‚å®¤ã§ã®ç®¡ç†ãŒå¿…è¦ã§ã—ãŸã€‚
    - å¸‚ä¸­è‚ºç‚ã«ã‚ˆã‚Šé‡ç—‡åŒ–ã—ã€ICUã§å…¨èº«ç®¡ç†ã‚’è¡Œã„ã¾ã—ãŸã€‚
    - è‚ºç‚æ²»ç™‚ä¸­ã«ç³–å°¿ç—…ã®è¡€ç³–ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒå¿…è¦ã¨ãªã‚Šã€ã‚¤ãƒ³ã‚¹ãƒªãƒ³æ²»ç™‚ã‚’è¡Œã„ã¾ã—ãŸã€‚
    - æ—¢å¾€ã«ç³–å°¿ç—…ãŒã‚ã‚Šã€æ„ŸæŸ“åŠ ç™‚ã¨ä¸¦è¡Œã—ã¦è¡€ç³–ç®¡ç†ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚
    - ç³–å°¿ç—…åˆä½µä¾‹ã§ã€å…¥é™¢ä¸­ã¯ã‚¤ãƒ³ã‚¹ãƒªãƒ³å°å…¥ã‚’å«ã‚ãŸç®¡ç†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
    - æŠ—èŒè–¬ã¯å½“åˆç‚¹æ»´ã§é–‹å§‹ã—ã€å…¨èº«çŠ¶æ…‹æ”¹å–„å¾Œã«å†…æœã¸åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚
    - å…¥é™¢ä¸­ã¯é™æ³¨æŠ—èŒè–¬ã§æ²»ç™‚ã‚’è¡Œã„ã€ãã®å¾ŒçµŒå£è–¬ã¸å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚
    - ç‚¹æ»´æŠ—èŒè–¬ã§åŠ ç™‚é–‹å§‹ã—ã€é€€é™¢å‰ã«å†…æœæŠ—èŒè–¬ã¸ç§»è¡Œã—ã¾ã—ãŸã€‚
    - æ²»ç™‚ã«ã‚ˆã‚Šç—‡çŠ¶ã¯æ”¹å–„ã—ã€å…¨èº«çŠ¶æ…‹å®‰å®šã®ãŸã‚è‡ªå®…é€€é™¢ã¨ãªã‚Šã¾ã—ãŸã€‚
    - ç‚ç—‡åå¿œã‚‚æ”¹å–„ã—ã€å•é¡Œãªãè‡ªå®…ã¸é€€é™¢ã—ã¦ã„ã¾ã™ã€‚
    - ç—…çŠ¶è»½å¿«ã‚’ç¢ºèªå¾Œã€åœ¨å®…å¾©å¸°ã¨ãªã‚Šã¾ã—ãŸã€‚
    - å‘¼å¸è‹¦ã§å…¥é™¢ã—SpO2ä½ä¸‹ã®ãŸã‚é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸã€‚èƒ¸éƒ¨Xç·šã§ã†ã£è¡€æ‰€è¦‹ãŒã‚ã‚Šã€åˆ©å°¿è–¬ã§æ”¹å–„ã—ã¾ã—ãŸã€‚è‚ºç‚ã¨ã—ã¦ã®æŠ—èŒè–¬æ²»ç™‚ã¯ä¸»ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    - èµ·åå‘¼å¸ã§æ•‘æ€¥æ¬é€ã•ã‚Œã€é…¸ç´ æŠ•ä¸ã§ã‚‚ä½é…¸ç´ ãŒç¶šã„ãŸãŸã‚NPPVã‚’å°å…¥ã—ã¾ã—ãŸã€‚åˆ©å°¿è–¬é™æ³¨ã§å‘¼å¸çŠ¶æ…‹ãŒæ”¹å–„ã—ã€æ„ŸæŸ“ã‚ˆã‚Šå¿ƒä¸å…¨å¢—æ‚ªãŒä¸»å› ã§ã—ãŸã€‚
    - å’³å—½ã¨å‘¼å¸è‹¦ã§å…¥é™¢ã—é…¸ç´ æŠ•ä¸ã‚’è¡Œã„ã¾ã—ãŸã€‚æ°—ç®¡æ”¯æ‹¡å¼µè–¬ã¨ã‚¹ãƒ†ãƒ­ã‚¤ãƒ‰ã§æ”¹å–„ã—ã€ç”»åƒã§æ˜ã‚‰ã‹ãªè‚ºç‚æ‰€è¦‹ã¯ä¹ã—ãCOPDå¢—æ‚ªãŒä¸­å¿ƒã§ã—ãŸã€‚
    - å‘¼å¸çŠ¶æ…‹æ‚ªåŒ–ã§å…¥é™¢ã—SpO2ä½ä¸‹ã®ãŸã‚é…¸ç´ æŠ•ä¸ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚é«˜äºŒé…¸åŒ–ç‚­ç´ è¡€ç—‡ã®ãŸã‚NPPVã‚’å°å…¥ã—ã€æŠ—èŒè–¬ã‚ˆã‚Šã‚‚COPDå¢—æ‚ªã¸ã®æ²»ç™‚ãŒä¸»ä½“ã§ã—ãŸã€‚
    - é«˜ç†±ã¨å’³ã§å…¥é™¢ã—SpO2ä½ä¸‹ã®ãŸã‚çŸ­æœŸé–“é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸã€‚è¿…é€Ÿæ¤œæŸ»ã§ã‚¤ãƒ³ãƒ•ãƒ«ã‚¨ãƒ³ã‚¶é™½æ€§ã§ã€æŠ—èŒè–¬ã§ã¯ãªãå¯¾ç—‡ç™‚æ³•ä¸­å¿ƒã§æ”¹å–„ã—ã¾ã—ãŸã€‚
    - å’³å—½ã¨ç—°ã€ç™ºç†±ã§å…¥é™¢ã—ã¾ã—ãŸãŒã€èƒ¸éƒ¨ç”»åƒã§è‚ºç‚æ‰€è¦‹ã¯æ˜ç¢ºã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å¯¾ç—‡ç™‚æ³•ã§æ”¹å–„ã—ã€é…¸ç´ æŠ•ä¸ã‚„ICUç®¡ç†ã¯ä¸è¦ã§ã—ãŸã€‚
    - åŠ´ä½œæ™‚å‘¼å¸å›°é›£ãŒå¢—æ‚ªã—å…¥é™¢ã€SpO2ä½ä¸‹ã®ãŸã‚é…¸ç´ æŠ•ä¸ã—ã¾ã—ãŸã€‚æ„ŸæŸ“å…†å€™ã¯ä¹ã—ãã€ã‚¹ãƒ†ãƒ­ã‚¤ãƒ‰æ²»ç™‚ãŒä¸­å¿ƒã§ã—ãŸï¼ˆæŠ—èŒè–¬ã¯è£œåŠ©çš„ã§ã—ãŸï¼‰ã€‚
    - ã‚€ã›è¾¼ã¿å¾Œã«ç™ºç†±ã¨å’³ãŒå‡ºç¾ã—å…¥é™¢ã—ã¾ã—ãŸã€‚èª¤åš¥æ€§è‚ºç‚ã¨ã—ã¦ç‚¹æ»´æŠ—èŒè–¬ã‚’é–‹å§‹ã—ã€åš¥ä¸‹è©•ä¾¡ã¨é£Ÿå½¢æ…‹èª¿æ•´ã‚’è¡Œã„ã¾ã—ãŸã€‚æ”¹å–„å¾Œã«å†…æœã¸åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚
    - é«˜ç†±ã§å…¥é™¢ã—ç‚ç—‡åå¿œé«˜å€¤ã®ãŸã‚ç‚¹æ»´æŠ—èŒè–¬ã§æ²»ç™‚é–‹å§‹ã—ã¾ã—ãŸã€‚å‘¼å¸å™¨ç—‡çŠ¶ã¯è»½åº¦ã§è‚ºç‚æ‰€è¦‹ã¯ä¹ã—ãã€è…ç›‚è…ç‚ãŒä¸»å› ã§ã—ãŸã€‚æ”¹å–„å¾Œã«å†…æœã¸åˆ‡ã‚Šæ›¿ãˆã¦é€€é™¢ã—ã¾ã—ãŸã€‚
    - é«˜ç†±ã¨æ„è­˜éšœå®³ã§å…¥é™¢ã—ã€ç‚¹æ»´æŠ—èŒè–¬ã¨è£œæ¶²ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚SpO2ä½ä¸‹ã§é…¸ç´ æŠ•ä¸ã‚‚è¡Œã„ã¾ã—ãŸãŒã€æ„ŸæŸ“å·£ã¯è‚ºã‚ˆã‚Šã‚‚ä»–éƒ¨ä½ãŒç–‘ã‚ã‚Œæ•—è¡€ç—‡ã¨ã—ã¦æ²»ç™‚ã—ã¾ã—ãŸã€‚
